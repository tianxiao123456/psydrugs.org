<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ— å…¬ç« çº¯å‡€ç‰ˆå¤„æ–¹å•</title>
    <style>
        /* --- å¼ºåˆ¶æŒ‡å®šæ‰“å°çº¸å¼ å¤§å°ä¸º A5 æ¨ªå‘ --- */
        @page {
            size: 210mm 148mm; 
            margin: 0; 
        }

        body {
            background-color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: "SimSun", "Songti SC", serif; 
            overflow: hidden; 
        }

        /* çº¸å¼ å®¹å™¨ */
        .paper {
            width: 210mm; 
            height: 148mm;
            background: #fff;
            padding: 5mm 10mm;
            box-sizing: border-box;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5); 
            color: #000;
            display: flex;
            flex-direction: column;
            user-select: none; 
            z-index: 1;
            transform-origin: center center;
        }

        /* --- æ‰“å°æ—¶çš„ç‰¹æ®Šæ ·å¼è¦†ç›– --- */
        @media print {
            body { 
                background: none; 
                margin: 0; 
                padding: 0; 
                display: block; 
                height: auto;
                width: 100%;
                overflow: visible;
            }
            
            .paper { 
                box-shadow: none; 
                margin: 0; 
                width: 210mm !important;
                height: 148mm !important;
                transform: none !important; 
                page-break-after: avoid;
                page-break-before: avoid;
            }

            .controls { display: none !important; }
            .barcode-bars { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .bar { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }

        /* --- 1. æ¡å½¢ç  --- */
        .barcode-wrapper {
            position: absolute;
            top: 5mm;
            left: 10mm;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            z-index: 20;
            background: #fff;
            padding: 2px;
            border: 1px dashed transparent;
            transition: border 0.2s;
        }
        .barcode-wrapper:hover { border-color: #ccc; }
        .barcode-bars { display: flex; height: 30px; align-items: flex-start; }
        .bar { background-color: #000; display: inline-block; height: 100%; }

        /* --- 2. åº•æ–¹æ¡† --- */
        .difang-box {
            position: absolute;
            top: 5mm;
            right: 5mm; 
            border: 1px solid #000;
            padding: 2px 10px;
            font-size: 16px;
            font-weight: bold;
            letter-spacing: 2px;
            z-index: 20;
            min-width: 40px;
            text-align: center;
            cursor: pointer;
            background: #fff;
        }

        /* --- 3. æŠ¬å¤´åŒºåŸŸ --- */
        .header-section { margin-top: 0; margin-bottom: 2px; position: relative; z-index: 10; width: 100%; }
        
        .title-row { 
            display: flex;
            justify-content: center; 
            align-items: center; 
            margin-bottom: 5px; 
            padding-right: 80px; 
            padding-left: 20px;
        }
        
        .hospital-input { 
            font-size: 26px; 
            font-weight: normal; 
            border: none; 
            outline: none; 
            text-align: right; 
            width: auto;
            min-width: 200px;
            font-family: inherit; 
            background: transparent; 
            letter-spacing: 1px; 
        }
        
        .doc-type { 
            font-size: 26px; 
            font-weight: normal; 
            letter-spacing: 2px; 
            font-family: inherit; 
            white-space: nowrap; 
            margin-left: 20px; 
        }

        .grid-row { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; font-size: 13px; margin-bottom: 2px; }
        .grid-left { justify-self: start; }
        .grid-center { justify-self: center; text-align: center; }
        .grid-right { justify-self: end; text-align: right; }
        .sub-input { border: none; outline: none; text-align: left; font-family: inherit; font-size: 13px; background: transparent; min-width: 60px; padding-left: 5px; }

        /* --- ä¿¡æ¯æ  --- */
        .info-bar { display: flex; justify-content: space-between; align-items: center; padding-bottom: 2px; margin-bottom: 2px; font-size: 16px; border-bottom: 2px solid #000; }
        .ib-left { display: flex; gap: 20px; width: 30%; }
        .ib-center { display: flex; justify-content: center; width: 30%; }
        .ib-right { display: flex; width: 40%; justify-content: flex-end; }
        .info-item { display: flex; align-items: center; white-space: nowrap; }
        .data-input { border: none; text-align: left; font-family: inherit; outline: none; margin-left: 0; padding-left: 2px; background: transparent; min-width: 40px; font-size: 16px; }
        
        /* --- 4. æ ¸å¿ƒè¡¨æ ¼ --- */
        .main-table-container { display: flex; flex-grow: 1; width: 100%; border: 2px solid #000; border-top: none; position: relative; margin-bottom: 5px; }
        .vertical-text { position: absolute; right: -25px; top: 50%; transform: translateY(-50%); writing-mode: vertical-rl; font-size: 13px; letter-spacing: 4px; font-weight: bold; }
        .left-col { width: 25%; border-right: 1px solid #000; display: flex; flex-direction: column; position: relative; }
        .diag-wrapper { padding: 5px; flex-grow: 1; display: flex; flex-direction: column; }
        .diag-label { font-weight: bold; font-size: 16px; margin-bottom: 5px; }
        .diag-content { flex-grow: 1; width: 100%; border: none; outline: none; resize: none; font-family: inherit; font-size: 15px; line-height: 1.5; background: transparent; }
        .note-section { border-top: 1px solid #000; padding: 15px 5px; font-size: 15px; font-weight: bold; line-height: 1.4; background: transparent; }
        .right-col { width: 75%; padding: 5px 10px; position: relative; display: flex; flex-direction: column; }
        .rp-symbol { position: absolute; left: 10px; top: 5px; font-size: 48px; font-weight: normal; font-family: "Times New Roman", serif; }
        .text-content { width: 100%; flex-grow: 1; border: none; outline: none; resize: none; font-family: inherit; font-size: 16px; line-height: 1.8; padding-left: 10px; padding-top: 60px; background: transparent; }
        .rx-footer-row { display: flex; justify-content: flex-end; gap: 20px; margin-top: 5px; padding-top: 5px; font-size: 14px; }
        .rx-sign-item { display: flex; align-items: center; }
        .rx-input { border: none; border-bottom: 1px solid #000; text-align: center; outline: none; font-family: "Kaishu", "SimSun", serif; background: transparent; width: 80px; margin-left: 5px; }
        
        /* åº•éƒ¨ --- */
        .footer { display: flex; justify-content: space-between; margin-top: 2px; font-size: 13px; }
        .sign-input { border: none; border-bottom: 1px solid #000; width: 60px; text-align: center; outline: none; font-family: "Kaishu", "SimSun", serif; background: transparent; }

        /* æ§åˆ¶é¢æ¿ (ç²¾ç®€ç‰ˆ) */
        .controls {
            position: fixed; top: 20px; right: 20px;
            background: rgba(255,255,255,0.98); 
            padding: 15px; border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4); width: 260px; z-index: 100000;
            font-size: 14px; border: 1px solid #ddd;
            max-height: 90vh; overflow-y: auto;
            font-family: sans-serif;
            color: #333; 
        }
        .controls-header { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; color: #d90000; cursor: move; user-select: none; font-weight: bold; }
        .control-group { margin-bottom: 12px; border-bottom: 1px dashed #eee; padding-bottom: 10px; }
        .control-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        .control-group input[type="text"], .control-group select { 
            width: 100%; padding: 6px; box-sizing: border-box; 
            border: 1px solid #ccc; border-radius: 3px; 
            background: #fff; color: #000;
        }
        .btn { width: 100%; padding: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 5px; }
        .btn:hover { background: #0056b3; }
        .btn-black { background: #333; margin-top: 0; }
        .btn-black:hover { background: #111; }
        .section-title { font-size: 12px; color: #666; margin-bottom: 5px; font-weight: bold; border-left: 3px solid #007bff; padding-left: 5px; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <!-- æç®€æ§åˆ¶é¢æ¿ -->
    <div class="controls" id="draggableControls">
        <h3 class="controls-header" id="controlsHandle">ğŸ› ï¸ è®¾ç½®é¢æ¿ (å¯æ‹–åŠ¨)</h3>
        
        <div class="section-title">å¤„æ–¹ç±»å‹</div>
        <div class="control-group">
            <label>å³ä¸Šè§’æ ‡è¯†ï¼š</label>
            <select id="typeSelect" onchange="updateTypeBox(this.value)">
                <option value="åº• æ–¹">åº• æ–¹</option>
                <option value="ç²¾ äºŒ">ç²¾ äºŒ</option>
                <option value="éº» é†‰">éº» é†‰</option>
                <option value="æ€¥ è¯Š">æ€¥ è¯Š</option>
                <option value="å„¿ ç§‘">å„¿ ç§‘</option>
                <option value="è‡ªå®šä¹‰">è‡ªå®šä¹‰...</option>
            </select>
            <input type="text" id="typeInput" class="hidden" style="margin-top:5px;" placeholder="è¾“å…¥è‡ªå®šä¹‰å†…å®¹" oninput="updateTypeBox(this.value)">
        </div>

        <div class="section-title">å¿«æ·æ“ä½œ</div>
        <div class="control-group" style="margin-bottom:0;">
            <button class="btn btn-black" onclick="refreshAllRandom()">ğŸ”„ ä¸€é”®æ¢å· (éšæœºæ—¥æœŸ)</button>
        </div>
        <button class="btn" onclick="exportToPDF()">ğŸ“„ å¯¼å‡º / æ‰“å° PDF</button>
    </div>

    <div class="paper" id="paperArea">
        <!-- æ¡å½¢ç  -->
        <div class="barcode-wrapper" onclick="refreshAllRandom()" title="ç‚¹å‡»åˆ·æ–°">
            <div class="barcode-bars" id="barcodeBars"></div>
        </div>

        <!-- æ ‡è¯†æ¡† -->
        <div class="difang-box" id="difangText" onclick="document.getElementById('typeSelect').focus()">åº• æ–¹</div>

        <!-- æŠ¬å¤´ -->
        <div class="header-section">
            <div class="title-row">
                <input class="hospital-input" id="headerHospitalName" value="XXå¸‚æŸæŸåŒ»é™¢">
                <div class="doc-type">å¤„ æ–¹ ç¬º</div>
            </div>
            
            <div class="grid-row">
                <div class="grid-left"></div>
                <div class="grid-center">
                    å®šç‚¹åŒ»ç–—æœºæ„ç¼–ç ï¼š<input class="sub-input" id="medCodeInput" value="H11010100001" style="width: 110px;">
                </div>
                <div class="grid-right">
                    å°±è¯Šç±»å‹ï¼š<input class="sub-input" value="æ™®é€šé—¨è¯Š">
                </div>
            </div>

            <div class="grid-row">
                <div class="grid-left"></div>
                <div class="grid-center">
                    å¤„æ–¹ç¼–å·ï¼š<input class="sub-input" id="prescNumInput" value="2024010100582" style="width: 140px;">
                </div>
                <div class="grid-right">
                    è´¹åˆ«ï¼š<input class="sub-input" value="è‡ªè´¹">
                </div>
            </div>

            <div class="grid-row">
                <div class="grid-left" style="padding-left: 0;">
                    ç§‘å®¤ï¼š<input class="sub-input" value="å†…ç§‘" style="width: 80px;">
                </div>
                <div class="grid-center">
                    è¯æˆ¿ï¼š<input class="sub-input" value="é—¨è¯Šè¯æˆ¿" style="width: 80px;">
                </div>
                <div class="grid-right">
                    èº«ä»½ï¼š<input class="sub-input" value="ä¸€èˆ¬äººå‘˜">
                </div>
            </div>
        </div>

        <!-- ä¿¡æ¯æ  -->
        <div class="info-bar">
            <div class="ib-left">
                <div class="info-item">å§“åï¼š<input class="data-input" id="patientName" style="width: 70px;"></div>
                <div class="info-item">æ€§åˆ«ï¼š<input class="data-input" style="width: 30px;"></div>
            </div>
            <div class="ib-center">
                <div class="info-item">å¹´é¾„ï¼š<input class="data-input" style="width: 50px;"></div>
            </div>
            <div class="ib-right">
                <div class="info-item" style="width: 100%;">å•ä½ï¼š<input class="data-input" style="width: 100%;"></div>
            </div>
        </div>
        
        <!-- è¡¨æ ¼åŒºåŸŸ -->
        <div class="main-table-container">
            <div class="vertical-text">åŒå¤„æ–¹åŒåˆ’ä»·</div>

            <div class="left-col">
                <div class="diag-wrapper">
                    <div class="diag-label">ä¸´åºŠè¯Šæ–­ï¼š</div>
                    <textarea class="diag-content"></textarea>
                </div>
                <div class="note-section">
                    è¯´æ˜ï¼šè¯ç‰©åç§°å‰æ ‡æ³¨æœ‰â–²è¡¨ç¤ºéœ€çš®è¯•è¯å“ã€‚
                </div>
            </div>

            <div class="right-col">
                <div class="rp-symbol">â„</div>
                <textarea class="text-content"></textarea>
                <div class="rx-footer-row">
                    <div class="rx-sign-item">åŒ»å¸ˆç­¾å­—ï¼š<input class="rx-input" style="width: 80px;"></div>
                    <div class="rx-sign-item">æ—¥æœŸï¼š<input class="rx-input" id="dateInput" style="width: 100px;"></div>
                </div>
            </div>
        </div>

        <div class="footer">
            <div>å®¡æ ¸ <input class="sign-input"></div>
            <div>è°ƒé… <input class="sign-input"></div>
            <div>æ ¸å¯¹ <input class="sign-input"></div>
            <div>å‘è¯ <input class="sign-input"></div>
            <div>é‡‘é¢ <input class="sign-input" style="width: 60px;"></div>
        </div>

    </div>

    <script>
        // --- æ ¸å¿ƒä¿®å¤ï¼šçª—å£è‡ªåŠ¨ç¼©æ”¾é€‚é…å±å¹• ---
        function resizePaper() {
            if (window.matchMedia('print').matches) return;
            const paper = document.getElementById('paperArea');
            const targetW = 800; // çº¦ 210mm çš„åƒç´ è½¬æ¢
            const targetH = 560; // çº¦ 148mm
            const scale = Math.min((window.innerWidth - 40) / targetW, (window.innerHeight - 40) / targetH, 1);
            paper.style.transform = `scale(${scale})`;
        }
        window.addEventListener('resize', resizePaper);
        window.addEventListener('load', resizePaper);

        // --- å¯¼å‡º PDF ---
        function exportToPDF() {
            const name = document.getElementById('patientName') ? document.getElementById('patientName').value : 'å¤„æ–¹';
            const date = document.getElementById('dateInput').value || 'æ—¥æœŸ';
            const originalTitle = document.title;
            document.title = `${name}_å¤„æ–¹ç¬º_${date}`;
            window.print();
            setTimeout(() => { document.title = originalTitle; }, 1000);
        }

        // --- æ ‡è¯†åˆ‡æ¢é€»è¾‘ ---
        function updateTypeBox(val) {
            const box = document.getElementById('difangText') || document.querySelector('.difang-box');
            const input = document.getElementById('typeInput');
            
            if (val === "è‡ªå®šä¹‰") {
                input.classList.remove('hidden');
                input.focus();
            } else {
                input.classList.add('hidden');
                box.innerText = val;
            }
        }
        document.getElementById('typeInput').addEventListener('input', function() {
            document.querySelector('.difang-box').innerText = this.value;
        });

        // --- åŸºç¡€ç”ŸæˆåŠŸèƒ½ ---
        function generateBarcode() {
            const container = document.getElementById('barcodeBars');
            container.innerHTML = '';
            const barCount = 35;
            for(let i=0; i<barCount; i++) {
                const bar = document.createElement('div');
                bar.className = 'bar';
                const width = Math.floor(Math.random() * 4) + 1;
                bar.style.width = width + 'px';
                const margin = Math.floor(Math.random() * 4) + 1;
                bar.style.marginRight = margin + 'px';
                container.appendChild(bar);
            }
        }

        function generateMedCode() {
            let code = 'H';
            for(let i=0; i<11; i++) { code += Math.floor(Math.random() * 10); }
            document.getElementById('medCodeInput').value = code;
        }

        function generatePrescNum() {
            const now = new Date();
            const daysBack = Math.floor(Math.random() * 90);
            const randomDate = new Date(now.getTime() - (daysBack * 24 * 60 * 60 * 1000));
            
            const year = randomDate.getFullYear();
            const month = String(randomDate.getMonth() + 1).padStart(2, '0');
            const day = String(randomDate.getDate()).padStart(2, '0');
            
            let randomPart = '';
            for(let i=0; i<5; i++) { randomPart += Math.floor(Math.random() * 10); }
            
            document.getElementById('prescNumInput').value = `${year}${month}${day}${randomPart}`;
            document.getElementById('dateInput').value = `${year}-${month}-${day}`;
        }

        function refreshAllRandom() {
            generateBarcode();
            generateMedCode();
            generatePrescNum();
        }

        // --- åˆå§‹åŒ–æ•°æ® ---
        refreshAllRandom();

        // --- æ§åˆ¶é¢æ¿æ‹–æ‹½é€»è¾‘ ---
        const controls = document.getElementById('draggableControls');
        const handle = document.getElementById('controlsHandle');
        let isDraggingC = false, cx0, cy0, ix0 = 0, iy0 = 0;

        handle.addEventListener('mousedown', (e) => {
            isDraggingC = true; cx0 = e.clientX; cy0 = e.clientY;
            const match = controls.style.transform.match(/translate3d\(([^p]+)px,\s*([^p]+)px/);
            if(match) { ix0 = parseFloat(match[1]); iy0 = parseFloat(match[2]); }
        });
        document.addEventListener('mousemove', (e) => {
            if(!isDraggingC) return;
            e.preventDefault();
            const dx = e.clientX - cx0; const dy = e.clientY - cy0;
            controls.style.transform = `translate3d(${ix0+dx}px, ${iy0+dy}px, 0)`;
        });
        document.addEventListener('mouseup', () => isDraggingC = false);

    </script>
</body>
</html>